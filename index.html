
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flashcard Inteligente Triad3</title>
  <script type="importmap">
  {
    "imports": {
      "@google/genai": "https://cdn.jsdelivr.net/npm/@google/genai@0.11.0/+esm"
    }
  }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg-main: #111827;
      --bg-surface: #1F2937;
      --text-primary: #F3F4F6;
      --text-secondary: #9ca3af;
      --accent-primary: #17A2B8;
      --accent-secondary: #22d3ee;
      --accent-gradient-blue: #2563eb;
      --color-error: #f92772;
      --color-border: #374151;
      --flashcard-height: 150px;
      /* Novas cores para os cards */
      --color-card-yellow: #FBBF24;
      --color-card-red: #EF4444;
    }

    html {
      background-color: var(--bg-main);
    }
    
    * {
        box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      margin: 0;
      background-color: var(--bg-main);
      color: var(--text-primary);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background-color: var(--bg-surface);
      padding: 30px 40px;
      border-radius: 16px;
      border: 1px solid var(--color-border);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
      width: 95%;
      max-width: 800px;
      text-align: center;
      margin-top: 20px;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    .title-container {
      display: flex;
      flex-direction: column;
      align-items: center; 
      justify-content: center; 
      gap: 15px; 
      margin-bottom: 25px; 
    }

    #appLogo {
      height: 100px; 
      width: 100px; 
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 0 15px rgba(23, 162, 184, 0.4);
    }

    .container h1 {
      color: var(--text-primary);
      margin: 0; 
      font-size: 2.2em;
      font-weight: 700;
    }

    .container p {
      margin-bottom: 25px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    textarea {
      width: 100%;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 16px;
      min-height: 120px;
      background-color: var(--bg-main);
      color: var(--text-primary);
      resize: vertical;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    textarea::placeholder {
        color: var(--text-secondary);
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.3), inset 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .buttons-bar {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    #generateButton {
        background: linear-gradient(to right, var(--accent-gradient-blue), var(--accent-secondary));
        color: var(--text-primary);
        box-shadow: 0 4px 10px -2px rgba(37, 99, 235, 0.3);
    }
    #generateButton:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px -2px rgba(37, 99, 235, 0.4);
    }

    #clearButton, #downloadCsvButton, #downloadPdfButton, #settingsButton {
        background-color: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--color-border);
    }
    #clearButton:hover, #downloadCsvButton:hover, #downloadPdfButton:hover, #settingsButton:hover {
        background-color: var(--color-border);
        color: var(--text-primary);
    }

    button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.4);
    }
    
    button:disabled,
    #generateButton:disabled {
      background: var(--color-border);
      color: var(--text-secondary);
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .error-message {
      color: var(--color-error);
      margin-top: 15px;
      font-weight: 500;
      min-height: 1.5em; 
    }

    .flashcards-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 30px;
    }

    .flashcard {
      background-color: transparent;
      height: var(--flashcard-height);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      perspective: 1000px;
      box-shadow: none;
      transition: transform 0.2s ease;
    }
    
    .flashcard:hover,
    .flashcard:focus-within {
      transform: translateY(-5px);
    }

    .flashcard-inner {
      position: relative;
      width: 100%;
      height: 100%;
      text-align: center;
      transition: transform 0.6s, box-shadow 0.3s;
      transform-style: preserve-3d;
      border-radius: 10px;
    }

    .flashcard.flipped .flashcard-inner {
      transform: rotateY(180deg);
    }

    .flashcard-front,
    .flashcard-back {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px; 
      box-sizing: border-box;
      border-radius: 10px;
      border: 2px solid var(--color-border);
      background-color: var(--bg-surface);
      overflow-y: auto; 
    }

    .flashcard-front {
      justify-content: center; 
    }

    .flashcard-back {
      justify-content: flex-start; 
      transform: rotateY(180deg);
    }
    
    .flashcard-inner.funnel-topo {
      box-shadow: 0 0 10px -2px var(--accent-gradient-blue);
    }
    .flashcard-inner.funnel-topo .flashcard-front,
    .flashcard-inner.funnel-topo .flashcard-back {
      border-color: var(--accent-gradient-blue);
    }
    .flashcard-inner.funnel-meio {
      box-shadow: 0 0 10px -2px var(--color-card-yellow);
    }
    .flashcard-inner.funnel-meio .flashcard-front,
    .flashcard-inner.funnel-meio .flashcard-back {
      border-color: var(--color-card-yellow);
    }
    .flashcard-inner.funnel-fundo {
      box-shadow: 0 0 10px -2px var(--color-card-red);
    }
    .flashcard-inner.funnel-fundo .flashcard-front,
    .flashcard-inner.funnel-fundo .flashcard-back {
      border-color: var(--color-card-red);
    }

    .term, .definition {
      max-width: 100%; 
      word-wrap: break-word; 
    }

    .term {
      font-size: 1.2em;
      font-weight: 500;
      color: var(--text-primary);
      text-align: center; 
    }

    .definition {
      font-size: 0.95em;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid var(--color-border);
      color: var(--text-secondary);
      font-size: 0.9em;
    }

    /* Settings Modal Styles */
    .modal {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(17, 24, 39, 0.8); 
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0s linear 0.3s;
    }

    .modal[aria-hidden="false"] {
      opacity: 1;
      visibility: visible;
      transition-delay: 0s;
    }

    .modal-content {
      background-color: var(--bg-surface);
      padding: 25px 30px;
      border-radius: 10px;
      border: 1px solid var(--color-border);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 700px;
      max-height: 85vh;
      overflow-y: auto;
      text-align: left;
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }
    
    .modal[aria-hidden="false"] .modal-content {
        transform: scale(1);
    }

    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--accent-primary);
      font-size: 1.8em;
    }

    .modal-content p {
      color: var(--text-secondary);
    }
    
    .modal-content #promptEditor {
      background-color: var(--bg-main);
      color: var(--text-primary);
      border: 1px solid var(--color-border);
    }

    .modal-content #promptEditor:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.3);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 10px;
    }
    
    .modal-actions button {
        padding: 10px 18px;
        font-size: 15px;
    }

    #savePromptButton {
        background: var(--accent-primary);
        color: var(--text-primary);
    }
    #savePromptButton:hover {
        background: var(--accent-secondary);
    }

    #restoreDefaultPromptButton, #closeSettingsButton {
        background-color: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--color-border);
    }
     #restoreDefaultPromptButton:hover, #closeSettingsButton:hover {
        background-color: var(--color-border);
        color: var(--text-primary);
     }


    /* Responsive adjustments */
    @media (max-width: 820px) {
      .flashcards-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
        font-size: 0.95em;
      }
      .container {
        padding: 20px;
        margin-top: 10px;
      }
      .flashcards-container {
        grid-template-columns: 1fr;
      }
      #appLogo {
        height: 80px; 
        width: 80px;
      }
      .container h1 {
        font-size: 1.8em; 
      }
      .buttons-bar {
        flex-direction: column;
        gap: 10px;
      }
      button {
        width: 100%;
      }
      .flashcard {
        min-height: 140px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title-container">
      <img id="appLogo" src="https://aisfizoyfpcisykarrnt.supabase.co/storage/v1/object/public/imagens/LOGO%20TRIAD3%20.png" alt="Triad3 Logo">
      <h1>Flashcard Inteligente Triad3</h1>
    </div>
    <p>
      Insira um tópico e nossa IA, atuando como especialista em marketing e estratégia, gerará flashcards com insights acionáveis e classificação de relevância (cores).
    </p>
    <textarea
      id="topicInput"
      aria-label="Tópico ou termos e definições para os flashcards"
      placeholder="digite aqui sua ideia ou necessidade com máximo detalhamento, por favor!"
    ></textarea>
    <div id="apiKeySetup" style="display: none; margin-bottom: 20px; padding: 15px; border: 1px solid var(--color-border); border-radius: 8px; background-color: var(--bg-main);">
      <p style="margin: 0 0 10px 0; font-weight: 500; color: var(--text-primary);">Configuração da Chave da API</p>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="password" id="apiKeyInput" placeholder="Cole sua Chave da API do Google Gemini aqui" style="flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid var(--color-border); background-color: var(--bg-surface); color: var(--text-primary);" aria-label="Chave da API do Google Gemini">
        <button id="saveApiKeyButton" style="padding: 10px 18px; border-radius: 6px; background-color: var(--accent-primary); color: var(--text-primary); border: none; cursor: pointer;">Salvar</button>
      </div>
      <p style="font-size: 0.8em; color: var(--text-secondary); margin-top: 8px; margin-bottom: 0;">Sua chave é salva localmente no seu navegador.</p>
    </div>
    <div class="buttons-bar">
      <button id="generateButton">Gerar Flashcards</button>
      <button id="clearButton">Limpar Tela</button>
      <button id="downloadCsvButton">Baixar (CSV)</button>
      <button id="downloadPdfButton">Baixar (PDF)</button>
      <button id="settingsButton">Configurações</button>
    </div>
    <div id="errorMessage" class="error-message" role="alert" aria-live="assertive"></div>
    <div id="flashcardsContainer" class="flashcards-container" aria-live="polite">
      <!-- Flashcards will be generated here -->
    </div>
    <footer>
      <p>Powered by: Triad3 Inteligência Digital - Todos os direitos reservados - 2025 - Chega de Imitações!</p>
    </footer>
  </div>

  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle" aria-hidden="true">
    <div class="modal-content">
      <h2 id="settingsModalTitle">Configurações do Prompt</h2>
      <p>
        Ajuste o modelo de prompt usado para instruir o agente de IA.
        Use <code>{{topic}}</code> onde o tópico que você inserir deve ser substituído.
        Isso permite refinar como os flashcards são gerados. Certifique-se de que o prompt instrui a IA a usar a tag <code>[Nível: Categoria]</code> para que as categorias sejam registradas (embora as cores agora sigam uma sequência fixa).
      </p>
      <textarea id="promptEditor" aria-label="Editor de Prompt do Agente"></textarea>
      <div class="modal-actions">
        <button id="savePromptButton">Salvar</button>
        <button id="restoreDefaultPromptButton">Restaurar Padrão</button>
        <button id="closeSettingsButton" aria-label="Fechar configurações">Fechar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { GoogleGenAI } from '@google/genai';
    const { jsPDF } = window.jspdf; 

    const topicInput = document.getElementById('topicInput');
    const generateButton = document.getElementById('generateButton');
    const clearButton = document.getElementById('clearButton');
    const downloadCsvButton = document.getElementById('downloadCsvButton');
    const downloadPdfButton = document.getElementById('downloadPdfButton');
    const settingsButton = document.getElementById('settingsButton');
    const flashcardsContainer = document.getElementById('flashcardsContainer');
    const errorMessage = document.getElementById('errorMessage');
    
    const settingsModal = document.getElementById('settingsModal');
    const promptEditor = document.getElementById('promptEditor');
    const savePromptButton = document.getElementById('savePromptButton');
    const restoreDefaultPromptButton = document.getElementById('restoreDefaultPromptButton');
    const closeSettingsButton = document.getElementById('closeSettingsButton');
    let previouslyFocusedElement = null;

    const apiKeySetup = document.getElementById('apiKeySetup');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const saveApiKeyButton = document.getElementById('saveApiKeyButton');

    let currentFlashcardsData = [];

    const DEFAULT_PROMPT_TEMPLATE = `Sua missão é criar um conjunto de flashcards de alto impacto e valor estratégico sobre o tópico: "{{topic}}".
Aja como um(a) especialista renomado(a) em marketing digital, neuromarketing, design instrucional, funis de vendas (AIDA, etc.), copywriting persuasivo e gatilhos mentais.

Cada flashcard deve ter um "Termo" e uma "Definição".
- O "Termo" deve ser um conceito chave, uma técnica, uma etapa crucial, ou uma pergunta estratégica relevante para o tópico.
- A "Definição" deve ser concisa, mas extremamente rica, clara, estratégica e acionável. Vá além do óbvio. Incorpore princípios de neuromarketing e gatilhos mentais onde aplicável para tornar a definição mais impactante e memorável. Se for um conceito de marketing, explique brevemente como ele se aplica ou seu benefício estratégico.

Crucial: No final de CADA definição, adicione uma tag de classificação no formato "[Nível: SuaCategoriaAqui]".
- Contexto de Funil/Processo (ex: Marketing de Conteúdo, Lançamento de Produto): Use "Topo", "Meio", "Fundo" para classificar o termo/definição de acordo com sua relevância estratégica em um funil ou processo.
- Contexto Geral/Conceitual (ex: História da Arte, Física Quântica): Use "Importante", "Muito Importante", "Extremamente Importante" para classificar a relevância, impacto ou complexidade do termo/definição dentro do escopo geral do tópico.
A sua expertise determinará a categoria mais apropriada para cada card.

Formate a saída como uma lista de pares "Termo: Definição [Nível: SuaCategoriaAqui]", com cada par em uma nova linha.

Exemplos de como você deve pensar e formatar:
1.  Para o tópico "Marketing de Conteúdo":
    Marketing de Conteúdo: Criação e distribuição de conteúdo valioso para atrair e engajar um público-alvo claramente definido, com o objetivo de impulsionar ações lucrativas do cliente. [Nível: Topo]
    Blog Post Otimizado para SEO: Artigo de blog estrategicamente escrito para rankear bem em motores de busca, atraindo tráfego orgânico qualificado para o topo do funil. [Nível: Topo]
    Lead Magnet (Ímã de Leads): Oferta de material rico (ebook, webinar) em troca de informações de contato, crucial para capturar leads na fase de consideração. [Nível: Meio]
    Estudo de Caso de Sucesso: Demonstração prática de como seu produto/serviço resolveu o problema de um cliente, gerando prova social e confiança para a decisão. [Nível: Fundo]

2.  Para o tópico "Gatilhos Mentais":
    Gatilho da Escassez: Técnica de persuasão que aumenta a percepção de valor de um produto/serviço ao limitar sua disponibilidade (tempo ou quantidade), incentivando a tomada de decisão rápida. [Nível: Muito Importante]
    Gatilho da Prova Social: Influenciar decisões mostrando que outras pessoas (especialmente semelhantes ou autoridades) já aprovaram ou usaram o produto/serviço. [Nível: Extremamente Importante]
    Gatilho da Reciprocidade: Oferecer algo de valor gratuitamente para criar um sentimento de "dívida" e aumentar a probabilidade de uma ação futura desejada. [Nível: Importante]

Gere entre 12 flashcards, idealmente 12, para cobrir diferentes aspectos do tópico. Priorize a qualidade e o impacto estratégico sobre a quantidade. Evite definições genéricas ou superficiais. Cada card deve ser uma pequena pílula de conhecimento estratégico.
Se, mesmo com sua expertise, você não conseguir gerar flashcards que atendam a esses critérios de profundidade e estratégia para o tópico "{{topic}}", responda com "Nenhum flashcard gerado."`;
    let currentPrompt = localStorage.getItem('customPrompt') || DEFAULT_PROMPT_TEMPLATE;

    if (!topicInput || !generateButton || !clearButton || !downloadCsvButton || !downloadPdfButton || !settingsButton || !flashcardsContainer || !errorMessage ||
        !settingsModal || !promptEditor || !savePromptButton || !restoreDefaultPromptButton || !closeSettingsButton || !apiKeySetup || !apiKeyInput || !saveApiKeyButton) {
      console.error('Elementos essenciais da UI ou do modal estão faltando no DOM.');
      if(errorMessage) errorMessage.textContent = 'Erro crítico: Elementos da UI ausentes. O aplicativo não pode iniciar.';
    } else {
      let ai;

      function initializeApi(key) {
        try {
          ai = new GoogleGenAI({ apiKey: key });
          errorMessage.textContent = 'API inicializada com sucesso!';
          setTimeout(() => errorMessage.textContent = '', 2000);
          apiKeySetup.style.display = 'none';
          generateButton.disabled = false;
          settingsButton.disabled = false;
          downloadCsvButton.disabled = true; // Still requires data
          downloadPdfButton.disabled = true; // Still requires data
          return true;
        } catch (e) {
          console.error("Erro ao inicializar a API:", e);
          errorMessage.textContent = 'A chave da API fornecida parece ser inválida.';
          localStorage.removeItem('userApiKey'); // Remove invalid key
          return false;
        }
      }

      function checkApiKeyAndInitialize() {
        const userApiKey = localStorage.getItem('userApiKey');
        const envApiKey = process.env.API_KEY;

        if (userApiKey) {
          initializeApi(userApiKey);
        } else if (envApiKey) {
          initializeApi(envApiKey);
        } else {
          errorMessage.textContent = 'Chave da API não configurada. Por favor, insira sua chave abaixo.';
          apiKeySetup.style.display = 'block';
          generateButton.disabled = true;
          downloadCsvButton.disabled = true;
          downloadPdfButton.disabled = true;
          settingsButton.disabled = true;
        }
      }
      
      saveApiKeyButton.addEventListener('click', () => {
        const newKey = apiKeyInput.value.trim();
        if (newKey) {
          if (initializeApi(newKey)) {
             localStorage.setItem('userApiKey', newKey);
             apiKeyInput.value = ''; // Clear after save
          }
        } else {
          errorMessage.textContent = 'Por favor, insira uma chave da API.';
        }
      });
      
      checkApiKeyAndInitialize(); // Run on startup
      
      // --- Clear Screen Logic ---
      clearButton.addEventListener('click', () => {
        topicInput.value = '';
        flashcardsContainer.innerHTML = '';
        currentFlashcardsData = [];
        downloadCsvButton.disabled = true;
        downloadPdfButton.disabled = true;
        errorMessage.textContent = '';
      });
      // --- End Clear Screen Logic ---

      // --- Settings Modal Logic ---
      function openSettingsModal() {
        previouslyFocusedElement = document.activeElement;
        promptEditor.value = currentPrompt;
        settingsModal.setAttribute('aria-hidden', 'false');
        promptEditor.focus();
      }

      function closeSettingsModal() {
        settingsModal.setAttribute('aria-hidden', 'true');
        if (previouslyFocusedElement) {
            previouslyFocusedElement.focus();
        }
      }

      settingsButton.addEventListener('click', openSettingsModal);
      closeSettingsButton.addEventListener('click', closeSettingsModal);
      
      savePromptButton.addEventListener('click', () => {
        const newPrompt = promptEditor.value.trim();
        if (newPrompt) {
            if (!newPrompt.includes('{{topic}}')) {
                alert("Atenção: O prompt personalizado não inclui o placeholder '{{topic}}'. Isso pode impedir que o tópico inserido seja usado corretamente na geração dos flashcards.");
            }
            if (!newPrompt.toLowerCase().includes('[nível:')) { 
                 alert("Atenção: O prompt personalizado não parece instruir a IA a usar '[Nível: Categoria]'. Isso é importante para a qualidade da categorização da IA, mesmo que as cores sejam sequenciais.");
            }
            currentPrompt = newPrompt;
            localStorage.setItem('customPrompt', currentPrompt);
            closeSettingsModal();
        } else {
            alert("O prompt não pode estar vazio.");
        }
      });

      restoreDefaultPromptButton.addEventListener('click', () => {
        if (confirm("Tem certeza que deseja restaurar o prompt padrão? Seu prompt personalizado será perdido.")) {
            promptEditor.value = DEFAULT_PROMPT_TEMPLATE;
            currentPrompt = DEFAULT_PROMPT_TEMPLATE;
            localStorage.removeItem('customPrompt');
        }
      });
      
      settingsModal.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          closeSettingsModal();
        }
      });
      // --- End Settings Modal Logic ---

      function escapeCsvField(field) {
        if (field === null || typeof field === 'undefined') {
            return '';
        }
        let stringField = String(field);
        if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
            stringField = stringField.replace(/"/g, '""');
            return `"${stringField}"`;
        }
        return stringField;
      }

      function downloadFlashcardsCSV() {
        if (currentFlashcardsData.length === 0) {
            errorMessage.textContent = 'Nenhum flashcard para baixar.';
            return;
        }
        const csvHeader = "Termo,Definição\n";
        const csvRows = currentFlashcardsData.map(fc => 
            `${escapeCsvField(fc.term)},${escapeCsvField(fc.definition)}`
        ).join("\n");
        const csvContent = '\uFEFF' + csvHeader + csvRows; 
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            const filename = "Flashcard-inteligente-triad3.csv"; 
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            errorMessage.textContent = `Flashcards baixados como ${filename}`;
        } else {
            errorMessage.textContent = 'Seu navegador não suporta downloads diretos.';
        }
      }
      downloadCsvButton.addEventListener('click', downloadFlashcardsCSV);

      function downloadFlashcardsPDF() {
        if (currentFlashcardsData.length === 0) {
            errorMessage.textContent = 'Nenhum flashcard para baixar.';
            return;
        }
        const doc = new jsPDF();
        const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
        const pageWidth = doc.internal.pageSize.width || doc.internal.pageSize.getWidth();
        const margin = 15;
        let yPosition = margin;
        const lineHeight = 7; 
        const spaceBetweenTermDefinition = 5;
        const spaceBetweenFlashcards = 10;
        doc.setFontSize(12);
        currentFlashcardsData.forEach((flashcard, index) => {
            if (index > 0 && yPosition + (lineHeight * 5) > pageHeight - margin) { 
                doc.addPage();
                yPosition = margin;
            }
            doc.setFont(undefined, 'bold');
            let termLines = doc.splitTextToSize(`Termo: ${flashcard.term}`, pageWidth - (margin * 2));
            doc.text(termLines, margin, yPosition);
            yPosition += termLines.length * lineHeight;
            doc.setFont(undefined, 'normal');
            yPosition += spaceBetweenTermDefinition;
            if (yPosition + lineHeight > pageHeight - margin) {
                 doc.addPage();
                 yPosition = margin;
            }
            let definitionLines = doc.splitTextToSize(`Definição: ${flashcard.definition}`, pageWidth - (margin * 2));
            doc.text(definitionLines, margin, yPosition);
            yPosition += definitionLines.length * lineHeight;
            yPosition += spaceBetweenFlashcards; 
        });
        const filename = "Flashcard-inteligente-triad3.pdf";
        doc.save(filename);
        errorMessage.textContent = `Flashcards baixados como ${filename}`;
      }
      downloadPdfButton.addEventListener('click', downloadFlashcardsPDF);

      generateButton.addEventListener('click', async () => {
        if (!ai) {
          errorMessage.textContent = 'A API não foi inicializada. Por favor, configure sua chave da API.';
          checkApiKeyAndInitialize(); // Re-trigger the check
          return;
        }
        const topic = topicInput.value.trim();
        if (!topic) {
          errorMessage.textContent = 'Por favor, insira um tópico ou alguns termos e definições.';
          flashcardsContainer.textContent = '';
          currentFlashcardsData = [];
          downloadCsvButton.disabled = true;
          downloadPdfButton.disabled = true;
          return;
        }
        errorMessage.textContent = 'Gerando flashcards...';
        flashcardsContainer.innerHTML = ''; 
        currentFlashcardsData = []; 
        generateButton.disabled = true;
        clearButton.disabled = true;
        downloadCsvButton.disabled = true;
        downloadPdfButton.disabled = true;
        settingsButton.disabled = true;
        try {
          const finalPrompt = currentPrompt.replace(/{{topic}}/g, topic);
          const result = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: finalPrompt,
          });
          const responseText = result.text;
          if (responseText && responseText.trim().toLowerCase() !== "nenhum flashcard gerado.") {
            const lines = responseText.split('\n');
            const categoryRegex = /\[Nível:\s*(Topo|Meio|Fundo|Importante|Muito\sImportante|Extremamente\sImportante)\]/i;
            lines.forEach((line) => {
              let currentLine = line.trim();
              let categoryValue = null;
              if (!currentLine) return;
              currentLine = currentLine.replace(/^\d+\.\s*/, '');
              const categoryMatch = currentLine.match(categoryRegex);
              if (categoryMatch && categoryMatch[1]) {
                categoryValue = categoryMatch[1].toLowerCase().replace(/\s+/g, ' '); 
                currentLine = currentLine.replace(categoryRegex, '').trim(); 
              }
              const parts = currentLine.split(/:\s*(.*)/s); 
              if (parts.length >= 2 && parts[0].trim()) {
                const term = parts[0].trim();
                const definition = parts[1] ? parts[1].trim() : ""; 
                if (definition) {
                  currentFlashcardsData.push({ term, definition, apiCategory: categoryValue });
                }
              }
            });
            if (currentFlashcardsData.length > 0) {
              errorMessage.textContent = '';
              currentFlashcardsData.forEach((flashcard, cardIndex) => {
                const cardDiv = document.createElement('div');
                cardDiv.classList.add('flashcard');
                cardDiv.setAttribute('aria-label', `Flashcard: ${flashcard.term}. Clique ou pressione Enter/Espaço para ver a definição.`);
                cardDiv.setAttribute('role', 'button');
                cardDiv.tabIndex = 0; 
                const cardInner = document.createElement('div');
                cardInner.classList.add('flashcard-inner');
                let colorClassToApply = '';
                if (cardIndex < 4) colorClassToApply = 'funnel-topo'; 
                else if (cardIndex < 8) colorClassToApply = 'funnel-meio'; 
                else colorClassToApply = 'funnel-fundo'; 
                cardInner.classList.add(colorClassToApply);
                const cardFront = document.createElement('div');
                cardFront.classList.add('flashcard-front');
                const termDiv = document.createElement('div');
                termDiv.classList.add('term');
                termDiv.textContent = flashcard.term;
                cardFront.appendChild(termDiv);
                const cardBack = document.createElement('div');
                cardBack.classList.add('flashcard-back');
                const definitionDiv = document.createElement('div');
                definitionDiv.classList.add('definition');
                definitionDiv.textContent = flashcard.definition;
                cardBack.appendChild(definitionDiv);
                cardInner.appendChild(cardFront);
                cardInner.appendChild(cardBack);
                cardDiv.appendChild(cardInner);
                const flipCard = () => cardDiv.classList.toggle('flipped');
                cardDiv.addEventListener('click', flipCard);
                cardDiv.addEventListener('keydown', (event) => {
                  if (event.key === 'Enter' || event.key === ' ') {
                    flipCard();
                    event.preventDefault(); 
                  }
                });
                flashcardsContainer.appendChild(cardDiv);
              });
            } else {
              errorMessage.textContent = 'Não foi possível gerar flashcards válidos a partir da resposta.';
            }
          } else if (responseText && responseText.trim().toLowerCase() === "nenhum flashcard gerado.") {
             errorMessage.textContent = 'O modelo indicou que nenhum flashcard pôde ser gerado para este tópico.';
          } else {
            errorMessage.textContent = 'Falha ao gerar flashcards ou resposta vazia/inesperada recebida.';
          }
        } catch (error) {
          console.error('Erro ao gerar flashcards:', error);
          let displayError = 'Ocorreu um erro ao gerar os flashcards.';
          if (error && error.message) {
            if (error.message.includes('API key not valid')) {
                displayError = 'A Chave da API não é válida. Verifique a configuração.';
                localStorage.removeItem('userApiKey'); // Remove invalid key
                checkApiKeyAndInitialize(); // Prompt for key again
            } else if (error.message.toLowerCase().includes('quota') || (error.status && error.status === 429)) {
                displayError = 'Cota da API excedida. Verifique sua conta ou tente mais tarde.';
            } else {
                 displayError = `Erro: ${error.message.substring(0,100)}${error.message.length > 100 ? '...' : '' }`; 
            }
          }
          errorMessage.textContent = displayError;
        } finally {
          generateButton.disabled = false;
          clearButton.disabled = false;
          settingsButton.disabled = false;
          const hasData = currentFlashcardsData.length > 0;
          downloadCsvButton.disabled = !hasData;
          downloadPdfButton.disabled = !hasData;
        }
      });
    }
  </script>
</body>
</html>